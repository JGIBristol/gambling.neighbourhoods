---
title: "Leaflet-maps"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Leaflet-maps}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = TRUE,
  eval = FALSE, # change to TRUE to produce the vignette and FALSE for the package build
  comment = "#>"
)
```

```{r setup, echo=FALSE, message=FALSE}
library(leaflet)
library(htmltools)
library(sp)
library(dplyr)
library(htmlwidgets)
# library(gambling.neighbourhoods)
library(devtools)
load_all()
```


# Gambling neighbourhoods using leaflet maps

This vignette demonstrates how to create interactive maps using the `leaflet` package in R to visualize the gambling neighbourhoods. In here we will load the geographical data containing the coordinates of gambling premises and the clustering results from HDBSCAN for different values of MinPts (2,3,4,5,10). 
We will create a separate map for each value of MinPts, showing the cluster centers and the number of gambling premises in each cluster. Clusters are in <span style="color:blue;">**blue**</span> and represented by polygons, each with a popup displaying the cluster ID and the number of gambling premises within that cluster. Each polygon is sized according to the number of gambling premises it contains. Gambling premises inside each cluster are shown also in <span style="color:blue;">**blue**</span>, while unclustered  (noise) points are shown in **black**. Each point (a gambling premise GP) has a popup displaying its ID.


## Load data
Load the geographical data (spatial points dataframe) containing the coordinates of gambling premises.

```{r load-data, echo=TRUE, message=FALSE}
xy <- readRDS("data/xy.rds")
```

## MinPts=2


Load dataframe with coordinates and cluster assignments
```{r k2, message=FALSE}
res2 <- readRDS("results/hdbscan_results_2.rds")
# Create a data frame from the spatial points
df2 <- create_df(res2,xy)
head(df2)
dim(df2)
```
Number of clusters (excluding noise):
```{r num-clusters-k2, message=FALSE}
k2 <- length(unique(df2$cluster)) - 1
k2
```
Number of noise points:
```{r num-noise-k2, message=FALSE}
df2_null <- create_df_null(df2)
n_noise_k2 <- nrow(df2_null)
n_noise_k2
```

Leaflet map for MinPts=2

```{r leaflet-map-k2, message=FALSE}
# Get the convex hulls for each cluster
cluster_hulls2 <- get_cluster_hulls(df2)
# Create the leaflet map
map2 <-leaflet_map(cluster_hulls2, df2, df2_null)
# saveWidget(map2, file="results/map_MinPt2.html")
map2

```
## MinPts=3
Load dataframe with coordinates and cluster assignments
```{r k3, message=FALSE}
res3 <- readRDS("results/hdbscan_results_3.rds")
# Create a data frame from the spatial points
df3 <- create_df(res3,xy)
head(df3)
dim(df3)
```
Number of clusters (excluding noise):
```{r num-clusters-k3, echo=FALSE, message=FALSE}
k3 <- length(unique(df3$cluster)) - 1
k3
```
Number of noise points:
```{r num-noise-k3, echo=FALSE, message=FALSE}
df3_null <- create_df_null(df3)
n_noise_k3 <- nrow(df3_null)
n_noise_k3
```     
Leaflet map for MinPts=3
```{r leaflet-map-k3, echo=FALSE, message=FALSE}
# Get the convex hulls for each cluster
cluster_hulls3 <- get_cluster_hulls(df3) 
# Create the leaflet map
map3 <-leaflet_map(cluster_hulls3, df3, df3_null)
# saveWidget(map3, file="results/map_MinPt3.html")
map3
``` 
## MinPts=4
Load dataframe with coordinates and cluster assignments
```{r k4, message=FALSE}
res4 <- readRDS("results/hdbscan_results_4.rds")
# Create a data frame from the spatial points
df4 <- create_df(res4,xy)   
head(df4)
dim(df4)
```
Number of clusters (excluding noise):
```{r num-clusters-k4, echo=FALSE, message=FALSE}
k4 <- length(unique(df4$cluster)) - 1
k4
```
Number of noise points:
```{r num-noise-k4, echo=FALSE, message=FALSE}
df4_null <- create_df_null(df4)
n_noise_k4 <- nrow(df4_null)
n_noise_k4
```     
Leaflet map for MinPts=4
```{r leaflet-map-k4, echo=FALSE, message=FALSE}
# Get the convex hulls for each cluster
cluster_hulls4 <- get_cluster_hulls(df4) 
# Create the leaflet map
map4 <-leaflet_map(cluster_hulls4, df4, df4_null)
#saveWidget(map4, file="data/map_MinPt4.html")
map4
``` 
## MinPts=5
Load dataframe with coordinates and cluster assignments
```{r k5, message=FALSE}
res5 <- readRDS("results/hdbscan_results_5.rds")
# Create a data frame from the spatial points
df5 <- create_df(res5,xy)   
head(df5)   
dim(df5)
```
Number of clusters (excluding noise):
```{r num-clusters-k5, echo=FALSE, message=FALSE}
k5 <- length(unique(df5$cluster)) - 1
k5
```
Number of noise points:
```{r num-noise-k5, echo=FALSE, message=FALSE}
df5_null <- create_df_null(df5)
n_noise_k5 <- nrow(df5_null)
n_noise_k5
```     
Leaflet map for MinPts=5
```{r leaflet-map-k5, echo=FALSE, message=FALSE}
# Get the convex hulls for each cluster
cluster_hulls5 <- get_cluster_hulls(df5) 
# Create the leaflet map    
map5 <-leaflet_map(cluster_hulls5, df5, df5_null)
#saveWidget(map5, file="results/map_MinPt5.html")
map5
``` 

## MinPts=10
Load dataframe with coordinates and cluster assignments
```{r k10, message=FALSE}
res10 <- readRDS("results/hdbscan_results_10.rds")
# Create a data frame from the spatial points
df10 <- create_df(res10,xy)   
head(df10)   
dim(df10)
```
Number of clusters (excluding noise):
```{r num-clusters-k10, echo=FALSE, message=FALSE}
k10 <- length(unique(df10$cluster)) - 1
k10
```
Number of noise points:
```{r num-noise-k10, echo=FALSE, message=FALSE}
df10_null <- create_df_null(df10)
n_noise_k10 <- nrow(df10_null)
n_noise_k10
```     
Leaflet map for MinPts=10
```{r leaflet-map-k10, echo=FALSE, message=FALSE}
# Get the convex hulls for each cluster
cluster_hulls10 <- get_cluster_hulls(df10) 
# Create the leaflet map    
map10 <-leaflet_map(cluster_hulls10, df10, df10_null)
#saveWidget(map10, file="results/map_MinPt10.html")
map10
```
<br>

## Summary statistics for HDBSCAN clustering with various MinPts values

<br>

```{r summary-clusters, echo=FALSE, message=FALSE}

tab <- data.frame(MinPts = c(2, 3, 4, 5, 10),
          N_clusters = c(k2, k3, k4, k5, k10),
          N_noise_points = c(n_noise_k2, n_noise_k3, n_noise_k4, n_noise_k5, n_noise_k10),
          Max_cluster_size = c(max(df2$Pop[df2$cluster != 0]),
                                max(df3$Pop[df3$cluster != 0]),
                                max(df4$Pop[df4$cluster != 0]),
                                max(df5$Pop[df5$cluster != 0]),
                                max(df10$Pop[df10$cluster != 0])),
          Min_cluster_size = c(min(df2$Pop[df2$cluster != 0]),
                                min(df3$Pop[df3$cluster != 0]),
                                min(df4$Pop[df4$cluster != 0]),
                                min(df5$Pop[df5$cluster != 0]),
                                min(df10$Pop[df10$cluster != 0]))

           )

# Format the table with better styling and more descriptive column names
knitr::kable(
  tab %>% 
    rename(
      "MinPts Parameter" = MinPts,
      "Number of Clusters" = N_clusters,
      "Unclustered Points" = N_noise_points,
      "Largest Cluster Size" = Max_cluster_size,
      "Smallest Cluster Size" = Min_cluster_size
    ),
  # caption = "Summary statistics for HDBSCAN clustering with various MinPts values",
  align = "c",
  digits = 0,
  format = "html",
) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  kableExtra::row_spec(which.max(tab$N_clusters), bold = TRUE, background = "#e6f7ff") %>%
  kableExtra::row_spec(which.min(tab$N_noise_points), bold = TRUE, background = "#e6fff7")
```

<br>